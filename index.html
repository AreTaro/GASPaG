<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8"> <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; /* Added some padding for smaller viewports */
      background-color: #f0f2f5; 
      color: #1c1e21; 
      display: flex;
      justify-content: center;
      align-items: flex-start; /* Align top for scrolling on small screens */
      min-height: 100vh;
      box-sizing: border-box;
    }
    .container { 
      background-color: #ffffff; 
      padding: 25px 30px; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1); 
      width: 100%;
      max-width: 480px; /* Slightly wider for Japanese text */
      box-sizing: border-box;
    }
    .language-selector-container {
      margin-bottom: 20px;
      text-align: right;
    }
    .language-selector-container label {
        margin-right: 8px;
        font-size: 14px;
        color: #4b4f56;
    }
    #languageSelector {
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid #dddfe2;
        font-size: 14px;
    }
    h1 { 
      color: #007BFF; 
      text-align: center; 
      font-size: 24px;
      margin-top: 0; /* Adjust if language selector is above */
      margin-bottom: 25px;
    }
    label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600; 
      font-size: 14px;
      color: #4b4f56;
    }
    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #dddfe2;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
    }
    input[type="text"] { 
      background-color: #f5f6f7;
      font-family: 'Courier New', Courier, monospace;
    }
    .checkbox-group { 
      margin-bottom: 20px; 
      display: flex;
      align-items: center;
    }
    .checkbox-group input[type="checkbox"] {
      margin-right: 10px;
      height: 18px; 
      width: 18px; 
    }
    .checkbox-group label { 
      font-weight: normal; 
      font-size: 15px;
      margin-bottom: 0; 
      color: #333;
    }
    button {
      background-color: #007BFF;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      width: 100%;
      transition: background-color 0.2s ease-in-out;
    }
    button:hover:not(:disabled) { background-color: #0056b3; }
    button:disabled {
        background-color: #ccd0d5;
        cursor: not-allowed;
    }
    .result-area {
      margin-top: 25px;
      display: none; 
    }
    .copy-button {
      background-color: #42b72a; 
      margin-top: 10px;
    }
    .copy-button:hover:not(:disabled) { background-color: #36a420; }
    #feedbackMessage { 
      margin-top: 15px; 
      text-align: center; 
      font-size: 14px;
      min-height: 20px; 
    }
    .error-message { color: #fa383e; }
    .success-message { color: #36a420; }
    .loader {
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #007BFF; 
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: none; 
      margin: 20px auto 0;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="language-selector-container">
        <label for="languageSelector" id="languageSelectorLabel">Language:</label>
        <select id="languageSelector">
            <option value="en">English</option>
            <option value="ja">日本語</option>
        </select>
    </div>

    <h1 id="appTitle">Password Generator</h1>

    <div>
      <label for="lengthInput" id="lengthLabel">Password Length (8-128):</label>
      <input type="number" id="lengthInput" value="16" min="8" max="128">
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="includeSpecialCheckbox" name="includeSpecial" checked>
      <label for="includeSpecialCheckbox" id="specialCharsLabel">Include Special Characters (!@#$...)</label>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="onlyNumbersCheckbox" name="onlyNumbers">
      <label for="onlyNumbersCheckbox" id="onlyNumbersLabel">Only Numbers (0-9)</label>
    </div>

    <button id="generateButton" onclick="handleGeneratePassword()">Generate Password</button>
    <div id="loader" class="loader"></div>

    <div id="passwordResultContainer" class="result-area">
      <label for="generatedPasswordInput" id="generatedPasswordLabel">Generated Password:</label>
      <input type="text" id="generatedPasswordInput" readonly>
      <button id="copyButton" onclick="handleCopyPassword()" class="copy-button">Copy to Clipboard</button>
    </div>

    <div id="feedbackMessage"></div>
  </div>

  <script>
    // --- UI Element References ---
    const lengthInput = document.getElementById('lengthInput');
    const includeSpecialCheckbox = document.getElementById('includeSpecialCheckbox');
    const onlyNumbersCheckbox = document.getElementById('onlyNumbersCheckbox');
    const generatedPasswordInput = document.getElementById('generatedPasswordInput');
    const passwordResultContainer = document.getElementById('passwordResultContainer');
    const feedbackMessage = document.getElementById('feedbackMessage');
    const loader = document.getElementById('loader');
    const generateButton = document.getElementById('generateButton');
    const copyButton = document.getElementById('copyButton');
    const languageSelector = document.getElementById('languageSelector');

    // --- Localization ---
    let currentLanguage = 'en'; // Default language

    const uiStrings = {
        languageSelectorLabel: { en: "Language:", ja: "言語:" },
        appTitle: { en: "Password Generator", ja: "パスワード生成ツール" },
        lengthLabel: { en: "Password Length (8-128):", ja: "パスワードの長さ (8-128):" },
        specialCharsLabel: { en: "Include Special Characters (!@#$...)", ja: "特殊文字を含める (!@#$...)" },
        onlyNumbersLabel: { en: "Only Numbers (0-9)", ja: "数字のみ (0-9)" },
        generateButtonText: { en: "Generate Password", ja: "パスワードを生成" },
        generatedPasswordLabel: { en: "Generated Password:", ja: "生成されたパスワード:" },
        copyButtonText: { en: "Copy to Clipboard", ja: "クリップボードにコピー" },
        
        // Feedback messages & Error messages
        copiedSuccess: { en: "Password copied to clipboard!", ja: "パスワードをクリップボードにコピーしました！" },
        copiedFallback: { en: "Password copied (fallback method)!", ja: "パスワードをコピーしました (フォールバック方式)！" },
        copyFailed: { en: "Copying failed. Please copy manually.", ja: "コピーに失敗しました。手動でコピーしてください。" },
        copyFailedError: { en: "Copying failed: {error}. Please copy manually.", ja: "コピーに失敗しました: {error}。手動でコピーしてください。" },
        
        lengthErrorUI: { en: "Password length must be between 8 and 128.", ja: "パスワードの長さは8～128文字にしてください。" }, // Client-side validation
        
        // Server-related messages
        serverErrorGeneric: { en: "An unexpected error occurred. No password generated.", ja: "予期せぬエラーが発生しました。パスワードは生成されませんでした。" },
        serverCommError: { en: "Error communicating with server: {error}", ja: "サーバーとの通信エラー: {error}" },
        serverLengthError: { en: "Password length must be between 8 and 128.", ja: "パスワードの長さは8～128文字である必要があります。" }, // Specifically for server validation message
        // Add more server error mappings if needed, e.g.:
        // serverNoCharTypesSelectedError: { en: "No character types selected for password generation.", ja: "生成用の文字タイプが選択されていません。" }
    };

    function updateUI(lang) {
        if (!uiStrings.appTitle[lang]) { // Fallback to English if lang is unsupported
            lang = 'en';
        }
        currentLanguage = lang;
        document.documentElement.lang = lang; // Set overall page language for accessibility

        document.getElementById('languageSelectorLabel').textContent = uiStrings.languageSelectorLabel[lang];
        document.getElementById('appTitle').textContent = uiStrings.appTitle[lang];
        document.getElementById('lengthLabel').textContent = uiStrings.lengthLabel[lang];
        document.getElementById('specialCharsLabel').textContent = uiStrings.specialCharsLabel[lang];
        document.getElementById('onlyNumbersLabel').textContent = uiStrings.onlyNumbersLabel[lang];
        generateButton.textContent = uiStrings.generateButtonText[lang];
        document.getElementById('generatedPasswordLabel').textContent = uiStrings.generatedPasswordLabel[lang]; // This label is inside a hidden div, but it's fine to update
        copyButton.textContent = uiStrings.copyButtonText[lang];

        // If a feedback message is visible, re-translate it if possible (or clear it)
        // For simplicity, we'll clear it. Persistent messages should be handled more carefully.
        clearFeedback();
    }

    languageSelector.addEventListener('change', (event) => {
        updateUI(event.target.value);
    });

    // --- Core Logic Functions (modified for localization) ---
    function updateCheckboxStates() {
      if (onlyNumbersCheckbox.checked) {
        includeSpecialCheckbox.checked = false;
        includeSpecialCheckbox.disabled = true;
      } else {
        includeSpecialCheckbox.disabled = false;
      }
    }
    onlyNumbersCheckbox.addEventListener('change', updateCheckboxStates);
    
    function showFeedback(messageKey, type = 'error', options = {}) {
        let message = (uiStrings[messageKey] && uiStrings[messageKey][currentLanguage]) ? uiStrings[messageKey][currentLanguage] : messageKey; 
        if (options.error) { 
            message = message.replace('{error}', options.error);
        }
        feedbackMessage.textContent = message;
        feedbackMessage.className = type === 'success' ? 'success-message' : 'error-message';
    }

    function clearFeedback() {
        feedbackMessage.textContent = '';
        feedbackMessage.className = '';
    }
    
    function setLoadingState(isLoading) {
        if (isLoading) {
            loader.style.display = 'block';
            generateButton.disabled = true;
            copyButton.disabled = true; 
        } else {
            loader.style.display = 'none';
            generateButton.disabled = false;
            copyButton.disabled = generatedPasswordInput.value === ''; 
        }
    }

    function handleGeneratePassword() {
      clearFeedback();
      setLoadingState(true);
      passwordResultContainer.style.display = 'none'; 
      generatedPasswordInput.value = '';

      const len = parseInt(lengthInput.value, 10);
      if (isNaN(len) || len < 8 || len > 128) {
        showFeedback('lengthErrorUI'); // Use key for translated message
        generatedPasswordInput.value = '';
        setLoadingState(false);
        return;
      }

      const options = {
        length: len,
        includeSpecial: includeSpecialCheckbox.checked && !onlyNumbersCheckbox.checked,
        onlyNumbers: onlyNumbersCheckbox.checked
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.error) {
            let serverMessageKey = 'serverErrorGeneric'; // Default
            if (result.error === "Password length must be between 8 and 128.") {
                serverMessageKey = 'serverLengthError';
            }
            // Add other `else if` for other specific server error strings if any
            showFeedback(serverMessageKey);
            generatedPasswordInput.value = ''; 
            passwordResultContainer.style.display = 'none';
          } else if (result.password !== undefined) { 
            generatedPasswordInput.value = result.password;
            if (result.password) { 
                passwordResultContainer.style.display = 'block';
            } else {
                passwordResultContainer.style.display = 'none';
            }
          } else { // Should not happen if server always returns object with password or error
            showFeedback('serverErrorGeneric');
            generatedPasswordInput.value = ''; 
            passwordResultContainer.style.display = 'none';
          }
          setLoadingState(false);
        })
        .withFailureHandler(function(error) {
          generatedPasswordInput.value = ''; 
          passwordResultContainer.style.display = 'none';
          setLoadingState(false);
          showFeedback('serverCommError', 'error', { error: error.message });
        })
        .generatePassword(options);
    }

    function handleCopyPassword() {
      clearFeedback();
      if (!generatedPasswordInput.value || copyButton.disabled) return;

      generatedPasswordInput.select();
      generatedPasswordInput.setSelectionRange(0, 99999); 

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(generatedPasswordInput.value)
          .then(() => {
            showFeedback('copiedSuccess', 'success');
          })
          .catch(err => {
            executeCopyFallback();
          });
      } else {
        executeCopyFallback();
      }
      setTimeout(clearFeedback, 3000); 
    }
    
    function executeCopyFallback() {
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showFeedback('copiedFallback', 'success');
            } else {
                showFeedback('copyFailed');
            }
        } catch (err) {
            showFeedback('copyFailedError', 'error', { error: err.message });
        }
    }
    
    // --- Initial Setup ---
    // Determine initial language (e.g., from browser, or default to 'en')
    // For simplicity, we default to 'en' then allow user to change.
    // Could also try: currentLanguage = navigator.language.startsWith('ja') ? 'ja' : 'en';
    // And set the selector: languageSelector.value = currentLanguage;
    updateUI(currentLanguage); // Apply default language strings on load
    updateCheckboxStates(); // Initial state for checkboxes
    setLoadingState(false); // Initial button states

  </script>
</body>
</html>
